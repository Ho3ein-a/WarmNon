const{validationResult:e}=require("express-validator"),bcrypt=require("bcryptjs"),jalali=require("jalaali-js"),Model=require("../../model/user/user");exports.signInValidation=async(s,r)=>{let t=e(s),a=s.body;if(t.isEmpty()){if(s.body.phoneDuplicated)r.status(200).render("user-signin",{reqBody:a,errorMessage:"شماره تلفن وارد شده تکراری است"});else if(s.body.userDuplicated)r.status(200).render("user-signin",{reqBody:a,errorMessage:"نام کاربری قبلا وارد شده"});else{let n=parseInt(s.body.user_id),o=s.body.name,d=s.body.phone,i=parseInt(s.body.dormitory),l=new Date().getFullYear(),c=new Date().getMonth()+1,u=new Date().getDate(),y=s.body.password,$=await bcrypt.hash(y,12),m=jalali.toJalaali(l,c,u),g=new Date().toLocaleTimeString(),b=`${m.jy}/${m.jm}/${m.jd} ${g}`;new Model().userSignIn(n,$,d,o,b,i).then(e=>{s.session.user_id=n,s.session.save(e=>{if(e)return r.status(200).render("user-login",{error:"خطایی رخ داده است"});r.status(201).redirect("/main")})}).catch(()=>r.status(500).render("user-login",{error:"خطایی رخ داده است، مجدد تلاش نمایید"}))}}else{t.array();let h=t.array()[0].msg;r.status(200).render("user-signin",{reqBody:a,errorMessage:h})}},exports.userAuthentication=async(s,r)=>{let t=e(s);if(!t.isEmpty()){let a=t.array()[0].msg;return r.status(200).render("user-login",{error:a})}if(s.body.incorrectUserId||s.body.incorrectPassword)return r.status(200).render("user-login",{error:"اطلاعات وارد شده نادرست می باشند"});s.session.isLoggedIn=!0,s.session.user_id=s.body.user_id,s.session.save(e=>{if(e)return r.status(200).render("user-login",{error:"خطایی رخ داده است"});r.status(200).redirect("/main")})},exports.mainPost=async(e,s)=>{let[r,t]=e.body.bread_id_type.split("-"),a=parseInt(e.session.user_id),n=new Date().getFullYear(),o=new Date().getMonth()+1,d=new Date().getDate(),i=jalali.toJalaali(n,o,d),l=new Date().toLocaleTimeString(),c=`${i.jy}/${i.jm}/${i.jd}`,u=parseInt(e.body.number),y=u*parseInt(e.body.price);u?new Model().addToCart(a,r,c,l,u,y,null,"تحویل معمولی",0,0).then(()=>{e.flash("message",{type:"success",text:"سفارش شما با موفقیت به سبد خرید اضافه شد"}),e.session.save(()=>{s.status(201).redirect("/main")})}).catch(()=>{e.flash("message",{type:"error",text:"سفارش شما با خطا مواجه شد لطفا مجدا تلاش کنید"}),e.session.save(()=>{s.status(500).redirect("/main")})}):e.session.save(()=>{e.flash("message",{type:"success",text:"لطفا تعداد نان را مشخص کنید"}),e.session.save(()=>{s.status(200).redirect("/main")})})},exports.removeFromCart=(e,s)=>{let r=e.body.orderId;new Model().deleteOrder(r).then(()=>{s.status(200).redirect("/cart")}).catch(()=>{e.flash("error","حذف از سبد خرید با خطا مواجه شد"),s.status(500).redirect("/cart")})},exports.cancelOrderPost=async(e,s)=>{let r=parseInt(e.body.order_id);new Model().updateCart(r).then(()=>{e.flash("success","سفارش با موفقیت لغو شد"),s.status(200).redirect("/cancel-orders")}).catch(r=>{e.flash("error","حذف سفارش با مشکل مواجه شد لطفا مجدا تلاش کنید"),s.status(500).redirect("/cancel-orders")})},exports.commentPost=async(e,s)=>{try{let r=parseInt(e.body.bread_id),t=e.body.comment,a=parseInt(e.session.user_id),n=new Date().getFullYear(),o=new Date().getMonth()+1,d=new Date().getDate(),i=jalali.toJalaali(n,o,d),l=`${i.jy}/${i.jm}/${i.jd}`,c=parseInt(e.body.rating),[u]=await new Model().commentsId(),y;do y=Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)+1;while(u.includes(y));await new Model().addComment(y,t,c,l),await new Model().addUserComment(y,a,r,l),e.flash("message",{type:"success",text:"با تشکر از نظر دهی شما"}),s.status(201).redirect("/comment")}catch($){e.flash("message",{type:"error",text:"خطا در ارسال نظر"}),s.status(500).redirect("/comment")}},exports.expressPOST=async(e,s)=>{let r=parseInt(e.body.orderId),t=parseInt(e.body.totalPrice);t+=6900,s.status(200).render("user-express",{total_price:t})};